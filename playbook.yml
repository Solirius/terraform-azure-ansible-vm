---
- name: Configure Docker on Terraform VM
  hosts: all
  become: true
  gather_facts: true

  tasks:
    - name: "1: Update apt cache and install preqrequistes"
      ansible.builtin.apt:
        name:
          - 'ca-certificates'
          - 'curl'
          - 'gnupg'
        update_cache: true
        state: present

    - name: "1.5: Upgrade all system packages"
      ansible.builtin.apt:
        upgrade: dist
        update_cache: true


    - name: "2: Create directory for Docker's GPG key"
      ansible.builtin.file:
        path: '/etc/apt/keyrings'
        state: directory
        mode: '0755'

    - name: "3: Download Docker's GPG key"
      ansible.builtin.get_url:
        url: "https://download.docker.com/linux/ubuntu/gpg"
        dest: "/etc/apt/keyrings/docker.asc"
        mode: '0644'
        force: true

    - name: "4: Set correct permissions for the GPG key"
      ansible.builtin.file:
        path: '/etc/apt/keyrings/docker.asc'
        mode: '0644'

    - name: "5: Add the Docker repository using shell"
      ansible.builtin.shell:
        cmd: |
          set -o pipefail

          echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
            $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
            tee /etc/apt/sources.list.d/docker.list > /dev/null
      args:
        executable: /bin/bash
        creates: /etc/apt/sources.list.d/docker.list

    - name: "6: Update apt cache (after adding new repo)"
      ansible.builtin.apt:
        update_cache: true

    - name: "7: Install Docker Engine"
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present

    - name: "8: Add user to the 'docker' group"
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: docker
        append: true

    - name: "9: Start and enable Docker service"
      ansible.builtin.service:
        name: docker
        state: started
        enabled: true
